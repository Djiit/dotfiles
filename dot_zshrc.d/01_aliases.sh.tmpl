#!/bin/bash

# Github aliases
ghpr() {
  git push -u origin HEAD
  export GHPR_DESCRIPTION=${1:-""}
  export GHPR_BRANCH=$(git branch --show-current)
  envsubst < $HOME/.config/github-pr-template.md > $HOME/.config/github-pr-template.md.tmp
  gh pr create --fill --draft --body-file=$HOME/.config/github-pr-template.md.tmp --head=$(git rev-parse --abbrev-ref HEAD)
}

# Jira aliases (using acli)
alias jme="acli jira workitem search --jql \"assignee = currentUser() AND project IS NOT EMPTY AND status not in (Done, Declined, Closed, Published, 'Won\'t do')\""
alias jc="acli jira workitem create --type \"Story\" --editor"
alias jcilot="acli jira workitem create --project \"ILOT\" --type \"Tâche\" --assignee \"@me\" --editor"

# Helper function to create Jira ticket with template
jct() {
  local temp_file=$(mktemp)
  cp $HOME/.config/jira-ticket-template.md "$temp_file"
  ${EDITOR:-vim} "$temp_file"
  
  # Extract summary (first non-empty line after "# Summary")
  local summary=$(grep -A 1 "^# Summary" "$temp_file" | tail -n 1 | sed 's/^\[//;s/\]$//')
  
  # Extract everything after "# Description" for the description
  local description=$(sed -n '/^# Description/,$p' "$temp_file" | tail -n +2)
  
  if [[ -n "$summary" && "$summary" != "[Brief one-line description of the ticket]" ]]; then
    echo "$description" | acli jira workitem create --summary "$summary" --description-file /dev/stdin "$@"
  else
    echo "❌ No summary provided. Ticket creation cancelled."
  fi
  
  rm "$temp_file"
}

# Others
{{ range .aliases -}}
alias {{ .name | quote }}={{ .command | quote }}
{{ end -}}
